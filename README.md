# PostgreSQL HA Cluster Setup & Check via Ansible

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è **—Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ PostgreSQL-–∫–ª–∞—Å—Ç–µ—Ä–∞** —Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π –≤ —Ä–µ–∂–∏–º–µ `master ‚Üí standby`, –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö —Å –∫–ª–∏–µ–Ω—Ç–∞.

–ö–ª–∞—Å—Ç–µ—Ä —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ **—Ç—Ä—ë—Ö —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö**:

- `pg-master` ‚Äî –≥–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä PostgreSQL
- `pg-standby` ‚Äî —Ä–µ–ø–ª–∏–∫–∞ (standby)
- `pg-client` ‚Äî –∫–ª–∏–µ–Ω—Ç, –ø–æ–¥–∫–ª—é—á–∞—é—â–∏–π—Å—è –∫ `pg-master`

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ —Å—Ä–µ–¥—Å—Ç–≤–∞

- **Ansible** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- **PostgreSQL 14** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –°–£–ë–î
- **pg_basebackup** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ standby-—Ä–µ–ø–ª–∏–∫–∏
- **systemd** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏ PostgreSQL
- **SSH** ‚Äî –¥–æ—Å—Ç—É–ø –∫ —É–¥–∞–ª—ë–Ω–Ω—ã–º –º–∞—à–∏–Ω–∞–º
- **Unix-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `postgres`** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –°–£–ë–î

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
postgres_cluster/
‚îú‚îÄ‚îÄ terraform/           # Terraform-–º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –í–ú
‚îú‚îÄ‚îÄ ansible/             # Ansible –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ inventory/       # inventory.ini —Å IP-–∞–¥—Ä–µ—Å–∞–º–∏ –í–ú
‚îÇ   ‚îú‚îÄ‚îÄ group_vars/      # –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îÇ   ‚îú‚îÄ‚îÄ roles/           # –†–æ–ª–∏: master, standby, client
‚îÇ   ‚îî‚îÄ‚îÄ site.yml         # –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–±—É–∫
|   |__ check.yml        # –ü–ª—ç–π–±—É–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```

---

## –ó–∞–ø—É—Å–∫

### 1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É



### 2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥ terraform –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```bash
cd postgres_cluster/terraform
cp terraform.tfvars.example terraform.tfvars
# –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è (cloud_id, folder_id, –ø—É—Ç—å –¥–æ JSON-–∫–ª—é—á–∞ –∏ SSH –∫–ª—é—á–∞)
```
–ü—Ä–∏–º–µ—Ä trea
### 3. –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É

```bash
terraform init
terrafom plan
terraform apply
```

### 4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Ansible –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä

```bash
cd ../ansible
ansible-playbook -i inventory/inventory.ini site.yml
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞

–í—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
cd ansible
ansible-playbook -i inventory.ini check.yml
ansible-playbook -i inventory.ini promote_standby.yml
```

### ansible-playbook -i inventory.ini check.yml
–≠—Ç–æ—Ç –ø–ª–µ–π–±—É–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL, –≤–∫–ª—é—á–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.

–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –æ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

#### –ù–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ (pg-master):

–Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ repuser –≤ pg_hba.conf (—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏);

–∑–Ω–∞—á–µ–Ω–∏–µ wal_level –≤ postgresql.conf (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å replica);

–¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è sysadmin –≤ pg_hba.conf;

–∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ listen_addresses (–¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑–≤–Ω–µ);

–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—É–¥–µ–Ω—Ç—ã –≤ –±–∞–∑–µ sysadmin_db (SELECT * FROM —Å—Ç—É–¥–µ–Ω—Ç—ã LIMIT 5).

#### –ù–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ (pg-standby):

–≤–∫–ª—é—á—ë–Ω –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä hot_standby –≤ postgresql.conf;

–¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è sysadmin –≤ pg_hba.conf;

—á—Ç–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—É–¥–µ–Ω—Ç—ã (SELECT * FROM —Å—Ç—É–¥–µ–Ω—Ç—ã LIMIT 5);

–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ (SELECT COUNT(*));

–Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ —Å id=3 (SELECT * FROM —Å—Ç—É–¥–µ–Ω—Ç—ã WHERE id=3);

—Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–ø–ª–∏–∫–∏) ‚Äî pg_is_in_recovery().

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ª–æ–≥-—Ñ–∞–π–ª—ã –Ω–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ:

- /home/ubuntu/check_postgres_pg-master.log
- /home/ubuntu/check_postgres_pg-standby.log

### ansible-playbook -i inventory.ini promote_standby.yml

–≠—Ç–æ—Ç –ø–ª–µ–π–±—É–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤ —Ä–µ–∂–∏–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ (promote), –∏ –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ—Ç / –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—Ç—É–¥–µ–Ω—Ç—ã.

–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –æ–Ω –¥–µ–ª–∞–µ—Ç:

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ pg-standby –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–ø–ª–∏–∫–∏.

–ï—Å–ª–∏ –¥–∞ ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç pg_ctlcluster 14 main promote.

–ñ–¥—ë—Ç, –ø–æ–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä –≤—ã–π–¥–µ—Ç –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–ø–ª–∏–∫–∏ (pg_is_in_recovery() = false).

–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É —Å—Ç—É–¥–µ–Ω—Ç—ã —Å ID 3 (–µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç).

–û–±–Ω–æ–≤–ª—è–µ—Ç –§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å id = 3 –Ω–∞ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–µ:

–ü–æ—Ç–∞–Ω–∏–Ω –ê–ª–µ–∫—Å–µ–π –í–ª–∞–¥–∏—Å–ª–∞–≤–æ–≤–∏—á

–í—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ SELECT * FROM —Å—Ç—É–¥–µ–Ω—Ç—ã WHERE id = 3;



## üìé –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Yandex Cloud –∞–∫–∫–∞—É–Ω—Ç
- Terraform >= 1.0
- Ansible >= 2.10
- SSH-–¥–æ—Å—Ç—É–ø –∫ –í–ú

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω SSH-–∫–ª—é—á –¥–ª—è –≤—Å–µ—Ö –º–∞—à–∏–Ω
- –í—Å–µ –ø–∞—Ä–æ–ª–∏ –∏ –ª–æ–≥–∏–Ω—ã –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ `group_vars/all.yml`

–ü—Ä–∏–º–µ—Ä all.yml:
```
postgres_version: 14
pg_data_dir: /var/lib/postgresql/14/main
replication_user: repuser
replication_password: ""
sysadmin_user: sysadmin
sysadmin_password: ""
sysadmin_db: sysadmin_db
your_name: '–ü–æ—Ç–∞–Ω–∏–Ω –ê–ª–µ–∫—Å–µ–π –í–ª–∞–¥–∏—Å–ª–∞–≤–æ–≤–∏—á'
student_id: 3
```
---

## üßë‚Äçüíª –ê–≤—Ç–æ—Ä—ã

–ê–≤—Ç–æ—Ä: `s14861078`
–ü—Ä–æ–µ–∫—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–∞–∫—Ç–∏–∫—É–º–∞ –ø–æ –∑–∞–ø—É—Å–∫—É PostgreSQL-–∫–ª–∞—Å—Ç–µ—Ä–∞.
